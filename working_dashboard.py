#!/usr/bin/env python
# -*- coding: utf-8 -*-
# Âú®Ê™îÊ°àÈñãÈ†≠Âä†ÂÖ•ÈÄôË°å‰æÜÂøΩÁï•È°ûÂûãÊ™¢Êü•
# type: ignore
"""
ËÉΩÊ≠£Â∏∏Â∑•‰ΩúÁöÑÂÑÄË°®Êùø
Â∞àÈñÄÈáùÂ∞çÊÇ®ÁöÑ Prometheus metrics Á´ØÈªûÂÑ™Âåñ
"""

import sys
import datetime
import pandas as pd
import time

# Dash ÂåØÂÖ•
try:
    import dash
    from dash.dependencies import Output, Input
    try:
        from dash import dcc, html
    except ImportError:
        import dash_core_components as dcc
        import dash_html_components as html
    import plotly.graph_objs as go
    print("‚úÖ Dash ÂåØÂÖ•ÊàêÂäü")
except ImportError as e:
    print(f"‚ùå Dash ÂåØÂÖ•Â§±Êïó: {e}")
    sys.exit(1)

# Ëá™ÂÆöÁæ©Ê®°ÁµÑÂåØÂÖ•
try:
    from config_loader import load_plc_points, load_devices
    from metrics_only_client import MetricsOnlyPrometheusClient
    print("‚úÖ Ëá™ÂÆöÁæ©Ê®°ÁµÑÂåØÂÖ•ÊàêÂäü")
except ImportError as e:
    print(f"‚ö†Ô∏è ÈÉ®ÂàÜÊ®°ÁµÑÂåØÂÖ•Â§±Êïó: {e}")
    print("Â∞á‰ΩøÁî®Âü∫Êú¨ÈÖçÁΩÆ")

    def load_plc_points():
        return {
            "metric_groups": [{
                "group_name":
                "Á≥ªÁµ±ÊåáÊ®ô",
                "metrics": [{
                    "id": "up",
                    "name": "Á≥ªÁµ±ÈÅãË°åÁãÄÊÖã",
                    "unit": ""
                }, {
                    "id": "process_cpu_seconds_total",
                    "name": "CPU ‰ΩøÁî®ÊôÇÈñì",
                    "unit": "Áßí"
                }, {
                    "id": "process_resident_memory_bytes",
                    "name": "Ë®òÊÜ∂È´î‰ΩøÁî®Èáè",
                    "unit": "bytes"
                }, {
                    "id": "http_requests_total",
                    "name": "HTTP Ë´ãÊ±ÇÁ∏ΩÊï∏",
                    "unit": "Ê¨°"
                }]
            }]
        }

    def load_devices():
        return {
            "devices": [{
                "id": "prometheus",
                "name": "Prometheus ‰º∫ÊúçÂô®"
            }, {
                "id": "system",
                "name": "Á≥ªÁµ±Áõ£Êéß"
            }]
        }

    class MetricsOnlyPrometheusClient:

        def __init__(self, metrics_url="http://sn.yesiang.com:9090/metrics"):
            self.metrics_url = metrics_url
            self.available = True

        def get_latest_data_for_metrics(self, metric_ids):
            import random
            return {mid: random.uniform(0, 100) for mid in metric_ids}

        def query_range(self, query, start_time, end_time, step):
            import random
            values = []
            for i in range(20):
                timestamp = time.time() - (20 - i) * 60
                value = random.uniform(20, 80)
                values.append([timestamp, str(value)])
            return [{'metric': {'__name__': query}, 'values': values}]


print("Ê≠£Âú®ÂàùÂßãÂåñÁµÑ‰ª∂...")

# ÂàùÂßãÂåñ
plc_config = load_plc_points()
device_config = load_devices()
prometheus_client = MetricsOnlyPrometheusClient("http://sn.yesiang.com:9090")

print("‚úÖ ÁµÑ‰ª∂ÂàùÂßãÂåñÂÆåÊàê")

# Âª∫Á´ãÊåáÊ®ôÊò†Â∞Ñ
metric_options = []
metric_info = {}

for group in plc_config['metric_groups']:
    for metric in group['metrics']:
        metric_options.append({'label': metric['name'], 'value': metric['id']})
        metric_info[metric['id']] = {
            'name': metric['name'],
            'unit': metric.get('unit', '')
        }

# Âª∫Á´ãË®≠ÂÇôÈÅ∏È†Ö
device_options = [{
    'label': dev['name'],
    'value': dev['id']
} for dev in device_config['devices']]

# Â¶ÇÊûúÂÆ¢Êà∂Á´ØÂèØÁî®ÔºåÂòóË©¶Áç≤ÂèñÂØ¶ÈöõÁöÑÊåáÊ®ô
if hasattr(prometheus_client, 'get_available_metrics'):
    try:
        available_metrics = prometheus_client.get_available_metrics()
        if available_metrics:
            print(f"‚úÖ ÁôºÁèæ {len(available_metrics)} ÂÄãÂØ¶ÈöõÊåáÊ®ô")

            # Ê∑ªÂä†ÂØ¶ÈöõÁôºÁèæÁöÑÊåáÊ®ôÂà∞ÈÅ∏È†Ö‰∏≠
            for metric in available_metrics[:20]:  # Âè™Ê∑ªÂä†Ââç20ÂÄã
                if metric not in metric_info:
                    metric_options.append({'label': metric, 'value': metric})
                    metric_info[metric] = {'name': metric, 'unit': ''}

            print(f"Á∏ΩË®à {len(metric_options)} ÂÄãÂèØÈÅ∏ÊåáÊ®ô")
    except Exception as e:
        print(f"‚ö†Ô∏è Áç≤ÂèñÂØ¶ÈöõÊåáÊ®ôÊôÇÁôºÁîüÈåØË™§: {e}")

# ÂàùÂßãÂåñ Dash ÊáâÁî®
app = dash.Dash(__name__)
app.title = "ECU Áõ£ÊéßÂÑÄË°®Êùø - ÂØ¶ÈöõÊï∏Êìö"

# Ë®≠ÂÆö‰ΩàÂ±Ä
app.layout = html.Div([
    html.H1("ECU Áõ£ÊéßÂÑÄË°®Êùø", style={
        'textAlign': 'center',
        'color': '#2E86C1'
    }),
    html.Div([
        html.P("üü¢ ÈÄ£Êé•Âà∞ÂØ¶Èöõ Prometheus Êï∏ÊìöÊ∫ê",
               style={
                   'textAlign': 'center',
                   'color': '#27AE60',
                   'fontWeight': 'bold'
               })
    ]),
    html.Div([
        html.Div([
            html.Label('ÈÅ∏ÊìáË®≠ÂÇô:', style={'fontWeight': 'bold'}),
            dcc.Dropdown(
                id='device-selector',
                options=device_options,
                value=device_options[0]['value'] if device_options else None,
                style={'marginTop': '5px'})
        ],
                 style={
                     'width': '48%',
                     'display': 'inline-block',
                     'padding': '10px'
                 }),
        html.Div(
            [
                html.Label('ÈÅ∏ÊìáÊåáÊ®ô (ÂèØÂ§öÈÅ∏):', style={'fontWeight': 'bold'}),
                dcc.Dropdown(
                    id='metric-selector',
                    options=metric_options,
                    value=[opt['value'] for opt in metric_options[:3]]
                    if len(metric_options) >= 3 else
                    [metric_options[0]['value']] if metric_options else [],
                    multi=True,
                    style={'marginTop': '5px'})
            ],
            style={
                'width': '48%',
                'float': 'right',
                'display': 'inline-block',
                'padding': '10px'
            })
    ],
             style={'marginBottom': '20px'}),
    html.Hr(),

    # ÁãÄÊÖãÈ°ØÁ§∫ÂçÄÂüü
    html.Div([
        html.Div(id='status-display',
                 style={
                     'textAlign': 'center',
                     'fontSize': '16px',
                     'margin': '20px',
                     'padding': '15px',
                     'backgroundColor': '#F8F9FA',
                     'borderRadius': '5px',
                     'border': '1px solid #DEE2E6'
                 })
    ]),

    # ÂúñË°®ÂçÄÂüü
    html.Div([dcc.Graph(id='data-graph', style={'height': '500px'})],
             style={'margin': '20px'}),

    # Á≥ªÁµ±ÁãÄÊÖã
    html.Div([
        html.H4('Á≥ªÁµ±ÁãÄÊÖã',
                style={
                    'textAlign': 'center',
                    'marginTop': '30px',
                    'color': '#34495E'
                }),
        html.Div(id='system-status',
                 style={
                     'textAlign': 'center',
                     'fontSize': '18px',
                     'fontWeight': 'bold',
                     'padding': '10px'
                 })
    ]),

    # Ëá™ÂãïÊõ¥Êñ∞ - ËºÉÈï∑ÁöÑÈñìÈöî‰ª•Ê∏õÂ∞ë‰º∫ÊúçÂô®Ë≤†Ëºâ
    dcc.Interval(id='interval-component', interval=10000,
                 n_intervals=0)  # 10ÁßíÊõ¥Êñ∞‰∏ÄÊ¨°
])


# ÂõûË™øÂáΩÊï∏
@app.callback([
    Output('status-display', 'children'),
    Output('data-graph', 'figure'),
    Output('system-status', 'children')
], [
    Input('interval-component', 'n_intervals'),
    Input('device-selector', 'value'),
    Input('metric-selector', 'value')
])
def update_dashboard(n, selected_device, selected_metrics):
    current_time = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")

    if not selected_metrics:
        return (html.Div([
            html.H5(f"Ë≥áÊñôÊõ¥Êñ∞ÊôÇÈñì: {current_time}", style={'color': '#2C3E50'}),
            html.P("Ë´ãÈÅ∏ÊìáË¶ÅÁõ£Ê∏¨ÁöÑÊåáÊ®ô", style={
                'color': '#E74C3C',
                'fontSize': '16px'
            })
        ]), {
            'data': [],
            'layout': {
                'title': 'Ë´ãÈÅ∏ÊìáÁõ£Ê∏¨ÊåáÊ®ô',
                'height': 500
            }
        }, html.Span("‚ö†Ô∏è Ë´ãÈÅ∏ÊìáÁõ£Ê∏¨ÊåáÊ®ô", style={'color': 'orange'}))

    # Áç≤ÂèñÂØ¶ÈöõÊï∏Êìö
    status_elements = [
        html.H5(f"Ë≥áÊñôÊõ¥Êñ∞ÊôÇÈñì: {current_time}",
                style={
                    'color': '#2C3E50',
                    'marginBottom': '15px'
                })
    ]

    try:
        latest_data = prometheus_client.get_latest_data_for_metrics(
            selected_metrics)

        data_rows = []
        valid_data_count = 0  # ÂàùÂßãÂåñËÆäÊï∏

        for metric_id in selected_metrics:
            value = latest_data.get(metric_id)
            name = metric_info.get(metric_id, {}).get('name', metric_id)
            unit = metric_info.get(metric_id, {}).get('unit', '')

            if value is not None:
                # Ê†πÊìöÊï∏ÂÄºË®≠ÂÆöÈ°èËâ≤
                if isinstance(value, (int, float)):
                    if value > 1000:
                        color = '#E74C3C'  # Á¥ÖËâ≤ - È´òÂÄº
                    elif value > 100:
                        color = '#F39C12'  # Ê©ôËâ≤ - ‰∏≠ÂÄº
                    else:
                        color = '#27AE60'  # Á∂†Ëâ≤ - Ê≠£Â∏∏ÂÄº
                else:
                    color = '#34495E'  # ÁÅ∞Ëâ≤ - ÂÖ∂‰ªñ

                data_rows.append(
                    html.Div([
                        html.Span(f"{name}: ", style={'fontWeight': 'bold'}),
                        html.Span(f"{value:.2f} {unit}" if isinstance(
                            value, (int, float)) else f"{value} {unit}",
                                  style={
                                      'color': color,
                                      'fontWeight': 'bold'
                                  })
                    ],
                             style={
                                 'margin': '5px 0',
                                 'fontSize': '14px'
                             }))
                valid_data_count += 1
            else:
                data_rows.append(
                    html.Div([
                        html.Span(f"{name}: ", style={'fontWeight': 'bold'}),
                        html.Span("ÁÑ°Êï∏Êìö",
                                  style={
                                      'color': '#95A5A6',
                                      'fontStyle': 'italic'
                                  })
                    ],
                             style={
                                 'margin': '5px 0',
                                 'fontSize': '14px'
                             }))

        status_elements.extend(data_rows)

        if valid_data_count > 0:
            status_elements.append(
                html.
                P(f"‚úÖ ÊàêÂäüÁç≤Âèñ {valid_data_count}/{len(selected_metrics)} ÂÄãÊåáÊ®ôÁöÑÊï∏Êìö",
                  style={
                      'color': '#27AE60',
                      'marginTop': '15px',
                      'fontSize': '12px'
                  }))
        else:
            status_elements.append(
                html.P("‚ùå Êú™ËÉΩÁç≤Âèñ‰ªª‰ΩïÊåáÊ®ôÊï∏Êìö",
                       style={
                           'color': '#E74C3C',
                           'marginTop': '15px'
                       }))

    except Exception as e:
        valid_data_count = 0  # Á¢∫‰øùËÆäÊï∏Ë¢´ÂÆöÁæ©
        status_elements.append(
            html.P(f"‚ùå Áç≤ÂèñÊï∏ÊìöÊôÇÁôºÁîüÈåØË™§: {e}",
                   style={
                       'color': '#E74C3C',
                       'marginTop': '15px'
                   }))
        latest_data = {}

    # Âª∫Á´ãÂúñË°®
    graphs = []
    colors = [
        '#3498DB', '#E74C3C', '#2ECC71', '#F39C12', '#9B59B6', '#1ABC9C',
        '#34495E', '#E67E22'
    ]

    try:
        for i, metric_id in enumerate(selected_metrics):
            if metric_id in latest_data and latest_data[metric_id] is not None:
                # Áç≤ÂèñÊ≠∑Âè≤Êï∏Êìö
                try:
                    history_data = prometheus_client.query_range(
                        metric_id,
                        int(time.time()) - 3600,  # ÈÅéÂéª1Â∞èÊôÇ
                        int(time.time()),
                        '5m'  # 5ÂàÜÈêòÈñìÈöî
                    )

                    if history_data and 'values' in history_data[0]:
                        timestamps = []
                        values = []

                        for ts, val in history_data[0]['values']:
                            timestamps.append(
                                datetime.datetime.fromtimestamp(float(ts)))
                            try:
                                values.append(float(val))
                            except (ValueError, TypeError):
                                values.append(0)

                        if timestamps and values:
                            graphs.append(
                                go.Scatter(
                                    x=timestamps,
                                    y=values,
                                    mode='lines+markers',
                                    name=metric_info.get(metric_id, {}).get(
                                        'name', metric_id),
                                    line=dict(color=colors[i % len(colors)],
                                              width=2),
                                    marker=dict(size=4),
                                    hovertemplate=
                                    '%{y:.2f}<br>%{x}<extra></extra>'))
                except Exception as e:
                    print(f"Áç≤Âèñ {metric_id} Ê≠∑Âè≤Êï∏ÊìöÂ§±Êïó: {e}")

        figure = {
            'data':
            graphs,
            'layout':
            go.Layout(title={
                'text': f'Ë®≠ÂÇô {selected_device} Âç≥ÊôÇÁõ£Ê∏¨Êï∏Êìö',
                'x': 0.5,
                'font': {
                    'size': 18,
                    'color': '#2C3E50'
                }
            },
                      xaxis={
                          'title': 'ÊôÇÈñì',
                          'showgrid': True
                      },
                      yaxis={
                          'title': 'Êï∏ÂÄº',
                          'showgrid': True
                      },
                      hovermode='x unified',
                      showlegend=True,
                      legend=dict(x=0, y=1, bgcolor='rgba(255,255,255,0.8)'),
                      plot_bgcolor='rgba(248,249,250,0.8)',
                      paper_bgcolor='rgba(255,255,255,1)',
                      height=500,
                      margin=dict(l=60, r=30, t=60, b=60))
        }
    except Exception as e:
        print(f"Âª∫Á´ãÂúñË°®ÊôÇÁôºÁîüÈåØË™§: {e}")
        figure = {
            'data': [],
            'layout': {
                'title': f'ÂúñË°®Âª∫Á´ãÈåØË™§: {e}',
                'height': 500
            }
        }

    # Á≥ªÁµ±ÁãÄÊÖã
    if valid_data_count > 0:
        system_status = html.Span("üü¢ Á≥ªÁµ±ÈÅãË°åÊ≠£Â∏∏", style={'color': '#27AE60'})
    else:
        system_status = html.Span("üî¥ Êï∏ÊìöÁç≤ÂèñÁï∞Â∏∏", style={'color': '#E74C3C'})

    return status_elements, figure, system_status


def safe_run_app():
    """ÂÆâÂÖ®ÂïüÂãïÊáâÁî®"""
    try:
        app.run(debug=False, host='0.0.0.0', port=8053)
    except AttributeError:
        app.run_server(debug=False, host='0.0.0.0', port=8053)


if __name__ == '__main__':
    print("üéâ ECU Áõ£ÊéßÂÑÄË°®ÊùøÊ∫ñÂÇôÂ∞±Á∑íÔºÅ")
    print("ÂÑÄË°®ÊùøÁ∂≤ÂùÄ: http://localhost:8053")
    print("Êåâ Ctrl+C ÂÅúÊ≠¢‰º∫ÊúçÂô®")
    print("\nÈÄôÂÄãÁâàÊú¨Áõ¥Êé•ÈÄ£Êé•Âà∞ÊÇ®ÁöÑ Prometheus metrics Á´ØÈªû")

    try:
        print("Ê≠£Âú®ÂïüÂãï‰º∫ÊúçÂô®...")
        safe_run_app()
    except KeyboardInterrupt:
        print("\n‰º∫ÊúçÂô®Â∑≤ÂÅúÊ≠¢")
    except Exception as e:
        print(f"ÂïüÂãï‰º∫ÊúçÂô®ÊôÇÁôºÁîüÈåØË™§: {e}")
        import traceback
        traceback.print_exc()
